如果让你做一个**写时复制的线程安全的list**该怎么做？

- 何时初始化list，初始化list的元素个数多少？list是有限大小吗？
- 如何保证线程安全，比如多个线程进行读写时如何保证线程是安全的？
- 如何保证使用迭代器遍历list时的数据一致性？

Java并发包中并发list：CopyOnWriteArrayList

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/winterliu-notes/concurrent/20201016152019.png)

**1.添加元素add（删除元素类似）**

比如对这个list进行add时，会先去获取独占锁，这样其它线程如果也去add时就会被阻塞挂起。CopyOnWriteArrayList进行add时，由于加了锁，所以整个add过程是原子性操作，并且：它添加一个元素并不是直接在原数组进行，而是首先复制一个快照，在快照中添加这个元素，然后将新数组替换原数组。

**2.获取指定元素**

会有**写时复制策略产生的弱一致性问题**。

**3.修改指定元素**

也是先获取独占锁，防止其他线程对其进行修改，然后获取array，看看要修改的元素和array中元素值是不是一样，不一样则创建新数组、复制、重新指向。

**4.弱一致性的迭代器**

所谓弱一致性迭代器，是指返回迭代器后，其他线程对list的增删改对迭代器是不可见的。如果在这个线程进行遍历期间，其他线程没有对这个list进行增删改，那么snapshot本身就是list的array，因为它们是引用关系，但是一旦在遍历期间有别的线程对list进行了增删改，那么这时snapshot就是快照了，因为别的线程增删改之后list里面的数组被新数组替换了，这时候老数组被snapshot引用。