### 什么是tmd虚拟内存？

为什么很多进程占用的内存加起来可以超过电脑的最大内存？这就是用到了虚拟内存。

操作系统为应用程序提供的其实是虚拟内存地址，**每一个应用程序都有一个一致的、私有的地址空间，所以每个进程看起来就像独占整个内存空间**。通过这种方式，每个进程都用一片连续完整的地址空间，然后再由CPU中包含的内存管理单元去完成虚拟地址到物理地址的转换。

那当所有进程占用的总内存超过最大内存空间怎么办呢？内存管理器会将物理内存单元保存到磁盘（用的时候再把数据从磁盘加载到内存）。**但是不要简单以为虚拟内存就是使用硬盘空间来扩展内存的技术**，虚拟内存的重要意义是：**它给每一个应用程序都定义了一个连续的虚拟地址空间，并且把内存扩展到硬盘**

### 局部性原理

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211222154751.png)

### 虚拟内存的技术实现

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211222162043.png)

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211223110109.png)

可能基本分页存储管理方式是用在以前的操作系统中，也就是直接用物理地址。。但是现在都是加一层虚拟内存地址，所以现在用的是请求分页管理方式，**具备了请求调页和页面置换功能**。

### 页面置换算法

地址映射过程中，若在页面中发现**所要访问的页面**不在内存，则发生缺页中断。

如果你要将一个页面移到内存，但是内存没有可用的空间，那就需要用页面置换算法将内存中的一个页面移出内存。

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211223101643.png)

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211223101657.png)

可以看到对于每个进程来说，都有一个一致的、一个完整的虚拟内存空间，就好像每个进程都独占整个内存一样；然后操作系统会维护一个表，记录某一个虚拟内存块映射到哪里，是映射物理内存还是磁盘，如果是映射到物理内存，说明命中了，就不用发生页面置换，如果是映射到磁盘，那么会发生缺页中断，操作系统会把相应的页面从磁盘中移到内存中，如果内存页面空间满了，则会用页面置换算法移出一个页面到磁盘。

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211223102514.png)

有以下页面置换算法：

OPT页面置换算法：最佳置换算法

FIFO先进先出页面置换算法：总是淘汰最先进入内存的页面

LRU最近最久未使用

LFU 最少使用页面置换算法



## 对虚拟内存的一些面试补充

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20220213233757.png)

共享对象：就是一个进程通过虚拟地址去修改物理地址，另外一个进程中对应的虚拟地址指向的物理地址的值也发生了变化（因为这两个进程通过不同的虚拟地址指向的是同一个物理地址嘛）

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20220213235300.png)

私有对象：私有对象就是，相同的那部分还是在物理内存，但是一个进程单独修改的那部分会复制到物理内存的另一个区域，然后这个执行修改的线程的这部分修改的虚拟地址就单独指向物理内存刚复制的那个地址。

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20220213235227.png)



