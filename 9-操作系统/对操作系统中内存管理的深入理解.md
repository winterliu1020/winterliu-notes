### 什么是内存管理啊

内存分配与回收malloc, free；然后是地址转换（也就是逻辑地址转成物理地址）

### 内存管理机制

你想想操作系统是怎么管理内存的呢？？

连续分配管理：块式管理

非连续式分配管理：

1. 页式管理：把内存分为固定大小的页，页相对于块更小，通过页表将逻辑地址和物理地址关联起来
2. 段式管理：页式管理中的页没有实际意义，而段式管理将内存划分成粒度更小的段，并且这些段有具体的意义，比如主程序段、子程序段、数据段、栈段，然后通过段表将逻辑地址和物理地址关联。
3. 段页式管理：先把内存分成各个段、然后在一个段中又分成不同的页。不管是各个段之间还是一个段内的各个页之间内存都是离散的。

### 想一下两个问题

上面都说将虚拟地址和物理地址进行关联，那怎么关联呢？怎么将虚拟地址转换到真正的物理地址呢？如果快速转换呢？

如果虚拟地址很大，那页式管理中页表也会很大。

#### 快表（提高虚拟地址到物理地址的转换速度）

针对第一个问题，如何快速通过逻辑地址找到物理地址，其实就是用到了**快表**，快表就是放在高速缓存的一个页表，原来页表都放在主内存中，需要两次访问主内存才能读取到内存数据，而通过快表，可能一次访问高速缓存+一次主内存就能找到读取内存数据。

操作系统会先去快表中找，找到了则直接访问主内存的该物理地址得到相应数据，没找到再去住内存的页表中找，然后把该页记录放到高速缓存。

#### 多级页表（防止页表过大占用过多内存空间）

为什么避免所有的页面都存在内存，所以可以用多级页表，比如二级页表，我**只在内存中放第一级页表**，而**二级页表可以不存在或者把二级页表放到磁盘中**。这样分级的方式，我还是可以覆盖所有的4G内存地址，但是在内存中页表空间占用从4M缩小到1k了；但是**需要动态的创建二级页表，所以会消耗更多的时间**。

总结：内存管理很多时候都会用到计算机中的局部性原理，也就是百分之20的内容会被百分之80的频率进行访问。

参考：https://www.polarxiong.com/archives/%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8%E5%A6%82%E4%BD%95%E8%8A%82%E7%BA%A6%E5%86%85%E5%AD%98.html 

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211220174902.png)

### CPU寻址、虚拟地址空间

我们C语言中的指针打印出来的那个地址其实是虚拟地址，由操作系统决定，并不是真正的物理地址，所以要有一个虚拟地址转成物理地址的过程。

CPU中有一个内存管理单元MMU，就是负责地址转换的。

![](https://winterliublog.oss-cn-beijing.aliyuncs.com/notes/20211220180022.png)

